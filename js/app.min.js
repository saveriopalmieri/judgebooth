var boothApp,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};(boothApp=angular.module("judgebooth",["ionic","angular-cache","pascalprecht.translate","judgebooth.services","judgebooth.controllers","judgebooth.translations"])).config(["$locationProvider","$stateProvider","$urlRouterProvider",function(t,e,n){return t.html5Mode(!window.offlineMode&&navigator.onLine),e.state("app",{url:"",abstract:!0,templateUrl:"views/menu.html",controller:"SideCtrl"}).state("app.home",{url:"/",views:{menuContent:{templateUrl:"views/home.html",controller:"HomeCtrl"}}}).state("app.question",{url:"/question/:id",views:{menuContent:{templateUrl:"views/question.html",controller:"QuestionCtrl"}}}).state("app.admin",{url:"/admin",abstract:!0}).state("app.admin.new",{url:"/new",views:{"menuContent@app":{templateUrl:"views/admin/new.html",controller:"AdminNewCtrl"}}}).state("app.admin.questions",{url:"/questions/:page",views:{"menuContent@app":{templateUrl:"views/admin/questions.html",controller:"AdminQuestionsCtrl"}}}).state("app.admin.question",{url:"/question/:id",views:{"menuContent@app":{templateUrl:"views/admin/question.html",controller:"AdminQuestionCtrl"}}}).state("app.admin.translations",{url:"/translations",views:{"menuContent@app":{templateUrl:"views/admin/translations.html",controller:"AdminTranslationsCtrl"}}}).state("app.admin.translation",{url:"/translation/:language/:id",views:{"menuContent@app":{templateUrl:"views/admin/translation.html",controller:"AdminTranslationCtrl"}}}).state("app.admin.users",{url:"/users",views:{"menuContent@app":{templateUrl:"views/admin/users.html",controller:"AdminUsersCtrl"}}}),n.otherwise("/")}]),boothApp.config(["$translateProvider",function(t){var e,n,r;return e=["en","br","ru","cn","tw","fr","pt","es","jp","de","it"],r=navigator.language||navigator.userLanguage,r=r.replace(/^(zh|pt)_/i,"").toLowerCase().substr(0,2),n="en",indexOf.call(e,r)>=0&&(n=r),t.useSanitizeValueStrategy("escaped"),t.registerAvailableLanguageKeys(e).preferredLanguage(n).fallbackLanguage("en")}]),boothApp.run(["questionsAPI","$rootScope","$state","$ionicPlatform","$window",function(t,e,n,r,a){return e.$on("$stateChangeSuccess",function(t,n){return e.state=n}),e.next=function(){return t.nextQuestion().then(function(t){return n.go("app.question",{id:t})})},e.keydown=function(t){var n;return n=t.keyCode,e.$broadcast("keydown",n)},r.ready(function(){var t;return e.online=navigator.onLine,(t=a.applicationCache).addEventListener("progress",function(){return e.cacheStatus=t.status}),t.addEventListener("error",function(){return e.$apply(function(){return e.cacheStatus=t.status})}),t.addEventListener("cached",function(){return e.$apply(function(){return e.cacheStatus=t.status})}),t.addEventListener("updateready",function(){return e.$apply(function(){return e.cacheStatus=t.status})}),t.addEventListener("noupdate",function(){return e.$apply(function(){return e.cacheStatus=t.status})})})}]),boothApp.directive("ngLoad",["$parse",function(t){return{restrict:"A",compile:function(e,n){var r;return r=t(n.ngLoad),function(t,e,n){return e.on("load",function(e){return t.$apply(function(){return r(t,{$event:e})})})}}}}]);
var controllers,indexOf=[].indexOf||function(e){for(var n=0,t=this.length;n<t;n++)if(n in this&&this[n]===e)return n;return-1};(controllers=angular.module("judgebooth.controllers",[])).controller("SideCtrl",["$scope","questionsAPI","$ionicScrollDelegate","$location","$ionicSideMenuDelegate",function(e,n,t,r,s){if(e.filter=n.filter(),e.filteredQuestions=[],e.languages=n.languages(),e.languageCounts={},e.offlineMode=window.offlineMode,n.sets().then(function(n){return e.sets=n.data}),e.languageFilter=function(n){return e.languageCounts[n.id]>0},n.questions().then(function(n){var t,r,s,u,i,o,a,l,c,g,d,f,h,m,p,w,q,v,$,C,b;for(e.setCounts={},i=0,g=(q=n.data).length;i<g;i++){for(b=[],o=0,d=(v=(w=q[i]).cards).length;o<d;o++)for(a=0,f=(u=v[o]).length;a<f;a++)C=u[a],indexOf.call(b,C)<0&&b.push(C);for(l=0,h=($=w.languages).length;l<h;l++)for(c=$[l],(t=e.languageCounts)[c]||(t[c]=0),e.languageCounts[c]++,p=0,m=b.length;p<m;p++)C=b[p],(r=e.setCounts)[c]||(r[c]={}),(s=e.setCounts[c])[C]||(s[C]=0),e.setCounts[c][C]++}return e.updateCount()}),e.showSets=function(){return e.setsShown=!e.setsShown,t.resize()},e.toggleSet=function(n){var t,r,s,u,i,o,a,l,c,g;switch("all"!==n&&"modern"!==n&&"standard"!==n&&"none"!==n||(e.filter.sets=[]),n){case"standard":for(t=0,u=(a=e.sets).length;t<u;t++)(g=a[t]).standard||e.filter.sets.push(g.id);break;case"modern":for(r=0,i=(l=e.sets).length;r<i;r++)(g=l[r]).modern||e.filter.sets.push(g.id);break;case"none":for(s=0,o=(c=e.sets).length;s<o;s++)g=c[s],e.filter.sets.push(g.id);break;default:indexOf.call(e.filter.sets,n)>=0?e.filter.sets.splice(e.filter.sets.indexOf(n),1):e.filter.sets.push(n)}return e.updateCount()},e.toggleDifficulty=function(n){return indexOf.call(e.filter.difficulty,n)>=0?e.filter.difficulty.splice(e.filter.difficulty.indexOf(n),1):e.filter.difficulty.push(n),e.updateCount()},e.updateCount=function(){var t,r,s,u,i;if(n.filterQuestions(e.filter,!1).then(function(n){return e.filteredQuestions=n}),e.setCount=0,e.setCounts[e.filter.language]){for(e.setCount=Object.keys(e.setCounts[e.filter.language]).length,u=[],t=0,r=(s=e.filter.sets).length;t<r;t++)i=s[t],e.setCounts[e.filter.language][i]&&u.push(e.setCount--);return u}},e.showQuestions=function(){if(e.filteredQuestions.length)return n.filter(e.filter),e.next()},e.$watch(function(){return s.isOpenLeft()},function(t){if(!t&&e.filteredQuestions.length)return n.filter(e.filter)}),e.tab="filter",e.user=n.user(),e.login=function(){return n.auth().then(function(n){if(null!=n.login&&(window.location.href=n.login),null!=n.role)return e.user=n},function(n){return e.user=n.data})},e.logout=function(){return n.logout(),e.user=!1,e.tab="filter"},e.toggleTab=function(n){return e.tab=n},null!=r.search().code)return n.auth(r.search().code).then(function(n){if(r.search("code",null),null!=n.redirect&&r.path(n.redirect),null!=n.role)return e.user=n},function(n){return r.search("code",null),e.user=n.data})}]),controllers.controller("HomeCtrl",["$scope","questionsAPI",function(e,n){return e.sets=[],e.languages=[],e.authors=[],e.questions=null,e.filtered=[],e.$on("$ionicView.enter",function(){return n.questions().then(function(t){var r,s,u,i,o,a,l,c,g,d,f,h,m,p;for(e.questions=t.data,n.filterQuestions().then(function(n){return e.filtered=n}),m=[],s=0,a=(d=e.questions).length;s<a;s++){for(f=(g=d[s]).author,indexOf.call(e.authors,f)<0&&e.authors.push(g.author),u=0,l=(h=g.cards).length;u<l;u++)for(i=0,c=(r=h[u]).length;i<c;i++)p=r[i],indexOf.call(e.sets,p)<0&&e.sets.push(p);m.push(function(){var n,t,r,s;for(s=[],n=0,t=(r=g.languages).length;n<t;n++)o=r[n],indexOf.call(e.languages,o)<0?s.push(e.languages.push(o)):s.push(void 0);return s}())}return m})})}]),controllers.controller("QuestionCtrl",["$scope","questionsAPI","$stateParams","$state","$ionicScrollDelegate",function(e,n,t,r,s){var u;return u="http://gatherer.wizards.com/Handlers/Image.ashx?type=card&",e.$on("$ionicView.enter",function(){return n.question(t.id).then(function(n){var t,s,i,o,a,l,c;if(!(null!=(o=n.metadata)?o.id:void 0))return r.go("app.home");for(e.question=n,c=[],s=0,i=(a=n.cards).length;s<i;s++)(t=a[s]).src=u+"name="+t.name,"split"!==(l=t.layout)&&"aftermath"!==l||(t.src=u+"name="+t.full_name),t.multiverseid&&(t.src=u+"multiverseid="+t.multiverseid),t.url&&(t.src=t.url),"aftermath"===t.layout&&t.name_en===t.full_name.substr(0,t.name_en.length)&&(t.layout="normal"),t.manacost=(t.manacost||"").replace(/\{([cwubrgx0-9]+)\}/gi,function(e,n){return"<i class='mtg mana-"+n.toLowerCase()+"'></i>"}).replace(/\{([2wubrg])\/([wubrg])\}/gi,function(e,n,t){return"<i class='mtg hybrid-"+(n+t).toLowerCase()+"'></i>"}),t.text=(t.text||"").replace(/\{([cwubrgx0-9]+)\}/gi,function(e,n){return"<i class='mtg mana-"+n.toLowerCase()+"'></i>"}).replace(/\{t\}/gi,"<i class='mtg tap'></i>").replace(/\{q\}/gi,"<i class='mtg untap'></i>").replace(/\{([2wubrg])\/([wubrg])\}/gi,function(e,n,t){return"<i class='mtg hybrid-"+(n+t).toLowerCase()+"'></i>"}).replace(/(\(.*?\))/gi,"<em>$1</em>"),n.question=n.question.replace(RegExp("("+t.name+")","ig"),"<b>$1</b>"),c.push(n.answer=n.answer.replace(RegExp("("+t.name+")","ig"),"<b>$1</b>"));return c})}),e.toggleAnswer=function(){if(e.answer=!e.answer,s.resize(),e.answer)return s.scrollBottom(!0)},e.$on("keydown",function(n,t){switch(t){case 37:return history.back();case 39:return e.next();case 38:case 40:return e.toggleAnswer()}})}]),controllers.controller("AdminNewCtrl",["$scope","questionsAPI","$stateParams","$window",function(e,n,t,r){return e.$on("$ionicView.enter",function(){return e.question={author:e.user.name,difficulty:"1",cards:[]}}),e.add=function(){return e.question.cards.push({})},e.delete=function(n){var t;if(t="Do you really want to delete '"+e.question.cards[n].name+"'?",!e.question.cards[n].id||confirm(t))return e.question.cards.splice(n,1)},e.suggest=function(e){return e.id="",e.preview=!1,e.name.length>1?n.admin.suggest(e.name).then(function(n){if(e.suggestions=n.data,1===e.suggestions.length)return e.id=e.suggestions[0].id}):e.suggestions=[]},e.select=function(e,n){return e.name=n.name,e.id=n.id,delete e.suggestions},e.keypress=function(n,t){var r;if(13===n.keyCode)return(null!=(r=t.suggestions)?r.length:void 0)&&e.select(t,t.suggestions[0]),n.preventDefault()},e.movecard=function(n,t){var r;return r=e.question.cards[n],e.question.cards[n]=e.question.cards[n+t],e.question.cards[n+t]=r},e.back=function(){return r.history.back()},e.save=function(){var t,r,s;for(t=0,r=(s=e.question.cards).length;t<r;t++)delete s[t].suggestions;return n.admin.save(e.question).then(function(t){return"success"===t.data?(alert("Question submitted"),n.admin.clearShortCache(),e.question={author:e.user.name,difficulty:"1",cards:[]}):alert("Error when submitting question")})}}]),controllers.controller("AdminQuestionsCtrl",["$scope","questionsAPI","$stateParams","$state",function(e,n,t,r){return e.page=parseInt(t.page,10),e.goto=function(){var e;if((e=prompt("Go to page"))>0)return r.go("app.admin.questions",{page:e-1})},e.questions=[],e.reload=function(){return n.admin.questions(e.page).then(function(n){return e.questions=n.data.questions,e.pages=n.data.pages},function(){return n.logout(),r.go("app.home")})},e.$on("$ionicView.enter",function(){return e.reload()}),e.languages=n.languages(),e.toggle=function(e){var t,r;return t=e.id,r=e.live,n.admin.save({id:t,live:r})},e.delete=function(t){if(confirm("Are you sure?"))return n.admin.delete(t.id).then(function(){return n.admin.clearShortCache(),t.deleted=!0,e.reload()})}}]),controllers.controller("AdminQuestionCtrl",["$scope","questionsAPI","$stateParams","$window","$state",function(e,n,t,r,s){return e.$on("$ionicView.enter",function(){return n.admin.question(t.id).then(function(n){return e.question=n.data},function(){return n.logout(),s.go("app.home")})}),e.add=function(){return e.question.cards.push({})},e.delete=function(n){var t;if(t="Do you really want to delete "+e.question.cards[n].name+"?",!e.question.cards[n].id||confirm(t))return e.question.cards.splice(n,1)},e.suggest=function(e){return e.id="",e.preview=!1,e.name.length>1?n.admin.suggest(e.name).then(function(n){if(e.suggestions=n.data,1===e.suggestions.length)return e.id=e.suggestions[0].id}):e.suggestions=[]},e.select=function(e,n){return e.name=n.name,e.id=n.id,delete e.suggestions},e.keypress=function(n,t){var r;if(13===n.keyCode)return(null!=(r=t.suggestions)?r.length:void 0)&&e.select(t,t.suggestions[0]),n.preventDefault()},e.movecard=function(n,t){var r;return r=e.question.cards[n],e.question.cards[n]=e.question.cards[n+t],e.question.cards[n+t]=r},e.back=function(){return r.history.back()},e.save=function(){var t,r,s;for(t=0,r=(s=e.question.cards).length;t<r;t++)delete s[t].suggestions;return n.admin.save(e.question).then(function(t){return"success"===t.data?(n.admin.clearMemoryCache(),e.back()):alert("Error when saving question")})}}]),controllers.controller("AdminTranslationsCtrl",["$scope","questionsAPI","$state",function(e,n,t){var r,s,u,i,o,a;if(e.user=n.user(),e.selected={language:(null!=(i=e.user)?i.languages[0]:void 0)||e.languages[1].id,search:""},null!=e.user&&e.user.languages.length)for(e.languages=[],r=0,u=(o=n.languages()).length;r<u;r++)a=(s=o[r]).id,indexOf.call(e.user.languages,a)>=0&&e.languages.push(s);return e.reload=function(r){return null==r&&(r=!1),r&&(e.translations=[]),r&&(e.selected.search=""),n.admin.translations(e.selected.language).then(function(n){return e.translations=n.data},function(){return n.logout(),t.go("app.home")})},e.$on("$ionicView.enter",function(){return e.reload()})}]),controllers.controller("AdminTranslationCtrl",["$scope","$stateParams","questionsAPI","$window","$state",function(e,n,t,r,s){var u,i,o,a;for(e.$on("$ionicView.enter",function(){return t.admin.translation(n.language,n.id).then(function(n){return e.translation=n.data},function(){return t.logout(),s.go("app.home")})}),u=0,o=(a=e.languages).length;u<o;u++)(i=a[u]).id===parseInt(n.language,10)&&(e.language=i);return e.back=function(){return r.history.back()},e.save=function(){var n;return n={id:e.translation.id,language_id:e.translation.language_id,question:e.translation.question_translated,answer:e.translation.answer_translated},t.admin.translate(n).then(function(n){return"success"===n.data?(t.admin.clearMemoryCache(),e.back()):alert("Error when saving question")})}}]),controllers.controller("AdminUsersCtrl",["$scope","questionsAPI","$state",function(e,n,t){var r,s,u,i;for(e.languages=[],e.roles=["admin","editor","translator","guest"],r=0,u=(i=n.languages()).length;r<u;r++)"en"!==(s=i[r]).code&&(e.languages[s.id]=s);return e.$on("$ionicView.enter",function(){return n.admin.users().then(function(n){return e.users=n.data},function(){return n.logout(),t.go("app.home")})}),e.add=function(){return e.users.push({edit:!0})},e.save=function(t){return n.admin.saveUser(e.users[t]).then(function(){return e.users[t].edit=!1})},e.delete=function(t){if(!e.users[t].email||confirm("Do you really want to delete this user?"))return n.admin.deleteUser(e.users[t].email).then(function(){return e.users.splice(t,1)})}}]);
var services,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};(services=angular.module("judgebooth.services",[])).service("questionsAPI",["$http","CacheFactory","$q","$translate","$location",function(e,t,n,r,i){var s,o,a,u,l,d;if(a={persistent:t("persistentCache",{storageMode:"localStorage"}),short:t("shortCache",{maxAge:864e5,storageMode:"localStorage",deleteOnExpire:"passive"}),session:t("sessionCache",{storageMode:"sessionStorage"}),memory:t("memoryCache",{maxAge:36e5,capacity:20,deleteOnExpire:"passive"})},o=[{id:1,code:"en",name:"English"},{id:2,code:"de",name:"German"},{id:3,code:"it",name:"Italian"},{id:4,code:"jp",name:"Japanese"},{id:5,code:"ko",name:"Korean"},{id:6,code:"br",name:"Portuguese (Brazil)"},{id:7,code:"ru",name:"Russian"},{id:8,code:"es",name:"Spanish"},{id:9,code:"cn",name:"Chinese Simplified"},{id:10,code:"tw",name:"Chinese Traditional"},{id:11,code:"fr",name:"French"},{id:12,code:"pt",name:"Portuguese (Portugal)"}],s="backend/?action=",a.persistent.get("filter"))for(u=0,d=o.length;u<d;u++)if((l=o[u]).id===parseInt(a.persistent.get("filter").language,10)){r.use(l.code);break}return{sets:function(){return e.get(s+"sets",{cache:a.short})},languages:function(){return o},questions:function(){return e.get(s+"questions",{cache:a.short})},question:function(t){var r,i;return r=n.defer(),l=this.filter().language,navigator.onLine?e.get(s+"question&lang="+l+"&id="+t,{cache:a.memory}).then(function(e){var t;return t=e.data,t.language=l,r.resolve(t)},function(){return r.reject()}):(i=e.get(s+"offline",{cache:a.memory}),n.all([this.questions(),i]).then(function(e){var n,i,s,o,a,u,d,c,f,g,m,h,p;if(g=e[0],(f=e[1]).data.questions[t]){for((c=f.data.questions[t][l]||f.data.questions[t][1]).cards=[],s=0,o=(m=f.data.questions[t].cards).length;s<o;s++)i=m[s],(n=f.data.cards[i]).name_en=n.name,(null!=(h=n.translations)?h[l]:void 0)&&(n.name=n.translations[l]),c.cards.push(n);for(u=0,a=(p=g.data).length;u<a;u++)(d=p[u]).id===parseInt(t,10)&&(c.metadata=d);return c.language=l,r.resolve(c)}return r.reject()},function(){return r.reject()})),r.promise},filter:function(e){var t,n,i,s,u,d,c;for(i=0,s=(c=this.languages()).length;i<s;i++)(l=c[i]).code===r.use()&&(t=l.id);if(n={language:t,sets:[],difficulty:[]},null!=e){for(d=0,u=o.length;d<u;d++)(l=o[d]).id===parseInt(e.language,10)&&r.use(l.code);a.persistent.put("filter",e),a.memory.remove("filteredQuestions")}return a.persistent.get("filter")||n},filterQuestions:function(e,t){var r;return null==t&&(t=!0),r=n.defer(),t&&a.memory.get("filteredQuestions")?r.resolve(a.memory.get("filteredQuestions")):(e||(e=this.filter()),this.questions().then(function(n){return function(i){var s,o,u,l,d,c,f,g,m,h,p,v,y,q,C,x,j,I,Q,O,R,S,b,k;for(O=[],f=0,g=(Q=i.data).length;f<g;f++)if(I=Q[f],!(R=parseInt(e.language,10),indexOf.call(I.languages,R)<0||e.difficulty.length&&(S=I.difficulty,indexOf.call(e.difficulty,S)>=0))){if(e.sets.length){for(l=!1,y=0,m=(b=I.cards).length;y<m;y++){for(c=!1,q=0,h=(s=b[y]).length;q<h;q++)k=s[q],indexOf.call(e.sets,k)<0&&(c=!0);if(l=!c)break}if(l)continue}O[C=I.difficulty]||(O[C]=[]),O[I.difficulty].push(I.id)}for(u=[],o=x=0,p=O.length;x<p;o=++x)for(Q=O[o],d=j=0,v=(Q=n.randomize(Q)).length;j<v;d=++j)I=Q[d],u[d*O.length+o]=I;return u=u.filter(function(e){return void 0!==e}),t&&a.memory.put("filteredQuestions",u),r.resolve(u)}}(this),function(){return r.reject()})),r.promise},nextQuestion:function(){var e;return e=n.defer(),this.filterQuestions().then(function(t){var n;return n=t[0],t.push(t.shift()),a.memory.put("filteredQuestions",t),e.resolve(n)},function(){return e.reject()}),e.promise},user:function(){return a.session.get("user")},logout:function(){return e.get(s+"logout"),a.session.remove("user"),a.session.remove("loginRedirect")},auth:function(t){var r,o;return r=n.defer(),o=s+"auth",t?o+="&token="+encodeURIComponent(t):a.session.put("loginRedirect",i.path()),e.get(o).then(function(e){return null!=e.data.role&&(a.session.put("user",e.data),e.data.redirect=a.session.get("loginRedirect"),a.session.remove("loginRedirect")),r.resolve(e.data)},function(e){return r.reject(e)}),r.promise},randomize:function(e){var t,n,r;for(null==e&&(e=[]),t=e.length;--t>0;)r=e[n=~~(Math.random()*(t+1))],e[n]=e[t],e[t]=r;return e},admin:{questions:function(t){return e.get(s+"admin-questions&page="+t)},question:function(t){return e.get(s+"admin-question&id="+t)},suggest:function(t){return e.get(s+"admin-suggest&name="+t)},save:function(t){return e.post(s+"admin-save",t)},delete:function(t){return e.post(s+"admin-delete&id="+t)},translations:function(t){return e.get(s+"admin-translations&lang="+t)},translation:function(t,n){return e.get(s+"admin-translation&lang="+t+"&id="+n)},translate:function(t){return e.post(s+"admin-translate",t)},users:function(){return e.get(s+"admin-users")},saveUser:function(t){return e.post(s+"admin-saveuser",t)},deleteUser:function(t){return e.post(s+"admin-deleteuser&email="+encodeURIComponent(t))},clearMemoryCache:function(){return a.memory.removeAll()},clearShortCache:function(){return a.short.removeAll()}}}}]);